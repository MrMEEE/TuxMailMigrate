<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalDAV Migration Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-cloud-arrow-up"></i> CalDAV Migration Manager
            </span>
            <span class="navbar-text text-white" id="workerStatus">
                <i class="bi bi-circle-fill text-success" id="workerIndicator"></i>
                <span id="workerText">Worker Ready</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid">
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="servers-tab" data-bs-toggle="tab" data-bs-target="#servers" type="button">
                    <i class="bi bi-server"></i> Servers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button">
                    <i class="bi bi-people"></i> Accounts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="syncs-tab" data-bs-toggle="tab" data-bs-target="#syncs" type="button">
                    <i class="bi bi-arrow-left-right"></i> Synchronizations
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Servers Tab -->
            <div class="tab-pane fade show active" id="servers" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Server Configurations</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddServerModal()">
                                    <i class="bi bi-plus-circle"></i> Add Server
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="serversList" class="list-group">
                                    <div class="text-center p-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">About Server Configs</h5>
                            </div>
                            <div class="card-body">
                                <p class="small mb-2">Server configurations define CalDAV/CardDAV server settings that can be reused for multiple accounts.</p>
                                <ol class="small">
                                    <li>Add your server configurations first</li>
                                    <li>Then create accounts that use these servers</li>
                                    <li>Multiple accounts can share the same server</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div class="tab-pane fade" id="accounts" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Accounts</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">
                                    <i class="bi bi-plus-circle"></i> Add Account
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="accountsList" class="list-group">
                                    <div class="text-center p-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Quick Start</h5>
                            </div>
                            <div class="card-body">
                                <ol class="small">
                                    <li>Go to Servers tab and add your servers</li>
                                    <li>Add accounts for each server</li>
                                    <li>Go to Synchronizations tab</li>
                                    <li>Create a sync job between accounts</li>
                                    <li>Start the synchronization</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Synchronizations Tab -->
            <div class="tab-pane fade" id="syncs" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Synchronization Jobs</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddSyncModal()">
                                    <i class="bi bi-plus-circle"></i> New Sync Job
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="syncJobsList">
                                    <div class="text-center p-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Add Server Modal -->
    <div class="modal fade" id="addServerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Server Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addServerForm">
                        <div class="mb-3">
                            <label class="form-label">Server Name *</label>
                            <input type="text" class="form-control" id="serverName" required placeholder="e.g., Carbonio Production">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server Type</label>
                            <select class="form-select" id="serverType" onchange="updateServerDefaults('add')">
                                <option value="">Select type...</option>
                                <option value="Carbonio">Carbonio</option>
                                <option value="Zimbra">Zimbra</option>
                                <option value="Mailcow">Mailcow</option>
                                <option value="Nextcloud">Nextcloud</option>
                                <option value="SOGo">SOGo</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server URL *</label>
                            <input type="url" class="form-control" id="serverUrl" required placeholder="https://dav.example.com">
                            <div class="form-text">Base URL of the CalDAV/CardDAV server</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Principal Path (Optional)</label>
                            <input type="text" class="form-control" id="serverPrincipalPath" placeholder="/principals/users/">
                            <div class="form-text">Leave empty for auto-discovery. Use {username} as placeholder.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="serverDescription" rows="2" placeholder="Optional notes about this server"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="serverVerifySSL" checked>
                            <label class="form-check-label" for="serverVerifySSL">
                                Verify SSL Certificate
                            </label>
                            <div class="form-text">Uncheck for self-signed certificates</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addServer()">Add Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Server Modal -->
    <div class="modal fade" id="editServerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Server Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editServerForm">
                        <input type="hidden" id="editServerId">
                        <div class="mb-3">
                            <label class="form-label">Server Name *</label>
                            <input type="text" class="form-control" id="editServerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server Type</label>
                            <select class="form-select" id="editServerType" onchange="updateServerDefaults('edit')">
                                <option value="">Select type...</option>
                                <option value="Carbonio">Carbonio</option>
                                <option value="Zimbra">Zimbra</option>
                                <option value="Mailcow">Mailcow</option>
                                <option value="Nextcloud">Nextcloud</option>
                                <option value="SOGo">SOGo</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server URL *</label>
                            <input type="url" class="form-control" id="editServerUrl" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Principal Path (Optional)</label>
                            <input type="text" class="form-control" id="editServerPrincipalPath">
                            <div class="form-text">Use {username} as placeholder.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editServerDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editServerVerifySSL">
                            <label class="form-check-label" for="editServerVerifySSL">
                                Verify SSL Certificate
                            </label>
                            <div class="form-text">Uncheck for self-signed certificates</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateServer()">Update Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAccountForm">
                        <div class="mb-3">
                            <label class="form-label">Account Name *</label>
                            <input type="text" class="form-control" id="accountName" required placeholder="e.g., john@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server *</label>
                            <select class="form-select" id="accountServerId" required>
                                <option value="">Select server...</option>
                            </select>
                            <div class="form-text">Select the server configuration to use</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="accountUsername" required placeholder="user@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" id="accountPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addAccount()">Add Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="modal fade" id="editAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAccountForm">
                        <input type="hidden" id="editAccountId">
                        <div class="mb-3">
                            <label class="form-label">Account Name *</label>
                            <input type="text" class="form-control" id="editAccountName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server *</label>
                            <select class="form-select" id="editAccountServerId" required>
                                <option value="">Select server...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="editAccountUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="editAccountPassword" placeholder="Leave empty to keep current password">
                            <div class="form-text">Only enter if you want to change the password</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateAccount()">Update Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Sync Job Modal -->
    <div class="modal fade" id="addSyncModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Sync Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSyncForm">
                        <div class="mb-3">
                            <label class="form-label">Job Name *</label>
                            <input type="text" class="form-control" id="syncName" required placeholder="e.g., Carbonio to Mailcow">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Account *</label>
                            <select class="form-select" id="syncSourceId" required>
                                <option value="">Select source...</option>
                            </select>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="discoverCollections('add')" id="discoverBtn">
                                    <i class="bi bi-search"></i> Discover &amp; Select Collections
                                </button>
                                <div id="selectedCollectionsInfo" class="small text-muted mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destination Account *</label>
                            <select class="form-select" id="syncDestinationId" required>
                                <option value="">Select destination...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syncMigrateCalendars" checked>
                                <label class="form-check-label" for="syncMigrateCalendars">
                                    Migrate Calendars
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syncMigrateContacts" checked>
                                <label class="form-check-label" for="syncMigrateContacts">
                                    Migrate Contacts
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syncCreateCollections" checked>
                                <label class="form-check-label" for="syncCreateCollections">
                                    Create Missing Collections
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syncSkipDummy">
                                <label class="form-check-label" for="syncSkipDummy">
                                    Skip Events Named "Dummy"
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSyncJob()">Create Job</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Sync Job Modal -->
    <div class="modal fade" id="editSyncModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Sync Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSyncForm">
                        <input type="hidden" id="editSyncId">
                        <div class="mb-3">
                            <label class="form-label">Job Name *</label>
                            <input type="text" class="form-control" id="editSyncName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Account *</label>
                            <select class="form-select" id="editSyncSourceId" required>
                                <option value="">Select source...</option>
                            </select>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="discoverCollections('edit')" id="editDiscoverBtn">
                                    <i class="bi bi-search"></i> Discover &amp; Select Collections
                                </button>
                                <div id="editSelectedCollectionsInfo" class="small text-muted mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destination Account *</label>
                            <select class="form-select" id="editSyncDestinationId" required>
                                <option value="">Select destination...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSyncMigrateCalendars">
                                <label class="form-check-label" for="editSyncMigrateCalendars">
                                    Migrate Calendars
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSyncMigrateContacts">
                                <label class="form-check-label" for="editSyncMigrateContacts">
                                    Migrate Contacts
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSyncCreateCollections">
                                <label class="form-check-label" for="editSyncCreateCollections">
                                    Create Missing Collections
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSyncSkipDummy">
                                <label class="form-check-label" for="editSyncSkipDummy">
                                    Skip Events Named "Dummy"
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateSyncJob()">Update Job</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Logs Modal -->
    <div class="modal fade" id="syncLogsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sync Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="syncLogsContent" style="max-height: 500px; overflow-y: auto;">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Select Collections Modal -->
    <div class="modal fade" id="selectCollectionsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select & Map Collections</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="discoverLoading" class="text-center p-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Discovering collections...</span>
                        </div>
                        <p class="mt-2 text-muted">Discovering collections from source and destination...</p>
                    </div>
                    
                    <div id="discoverError" class="alert alert-danger" style="display: none;"></div>
                    
                    <div id="collectionsContent" style="display: none;">
                        <ul class="nav nav-tabs mb-3" id="collectionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="calendars-tab" data-bs-toggle="tab" data-bs-target="#calendars-pane" type="button">
                                    <i class="bi bi-calendar"></i> Calendars
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="addressbooks-tab" data-bs-toggle="tab" data-bs-target="#addressbooks-pane" type="button">
                                    <i class="bi bi-person"></i> Address Books
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="collectionTabContent">
                            <!-- Calendars Tab -->
                            <div class="tab-pane fade show active" id="calendars-pane" role="tabpanel">
                                <p class="text-muted small mb-3">
                                    Select source calendars to migrate and optionally map them to existing destination calendars.
                                    If no destination is selected, a new calendar with the same name will be created.
                                </p>
                                <div class="text-end mb-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllCollections('calendars', true)">Select All</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllCollections('calendars', false)">Deselect All</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th width="50">Sync</th>
                                                <th>Source Calendar</th>
                                                <th width="50"></th>
                                                <th>Destination Calendar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="calendarsList">
                                            <tr><td colspan="4" class="text-center text-muted">No calendars found</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Address Books Tab -->
                            <div class="tab-pane fade" id="addressbooks-pane" role="tabpanel">
                                <p class="text-muted small mb-3">
                                    Select source addressbooks to migrate and optionally map them to existing destination addressbooks.
                                    If no destination is selected, a new addressbook with the same name will be created.
                                </p>
                                <div class="text-end mb-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllCollections('addressbooks', true)">Select All</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllCollections('addressbooks', false)">Deselect All</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th width="50">Sync</th>
                                                <th>Source Address Book</th>
                                                <th width="50"></th>
                                                <th>Destination Address Book</th>
                                            </tr>
                                        </thead>
                                        <tbody id="addressbooksList">
                                            <tr><td colspan="4" class="text-center text-muted">No addressbooks found</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCollectionSelection()">Save Selection</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
